%extract the coordinates out of the cresis kml file (might work for others,
%too)
i=1;
%progress bar initialization
tic;
waitmode=-1;
lasttime=0;
%12 characters are subtracted because due to kml formatting there is no
%possible coordinate data in 12 characters
file_length=length(kmlstring)-12;
while(i<file_length)
    if (kmlstring(i)=='<')
        if strcmp(kmlstring(i+1:i+12), 'coordinates>')
            coords=sscanf(kmlstring(i+13:size(kmlstring,2)), '%f,%f,%f');
            %if this fails, probably the data is not in triplets
            coords=reshape(coords, 3, size(coords,1)/3);
            coords=coords';
            %plot([coords(1,1) coords(size(coords,1),1)], [coords(1,2) coords(size(coords,1),2)], 'o', 'color', seg_color);
            %plot(coords(:, 1), coords(:, 2), 'color', seg_color);
            %counter=counter+size(coords,1);
            for k=1:size(coords,1)
                fprintf(fid, '%f %f %f\n', coords(k, :));
            end
        end
    end
    i=i+1;
    %progress bar code
    if ~mod(i,100)
        etime=toc;
        progress=(i/file_length);
        if ~waitmode
            esecs=mod(etime, 60);
            emins=mod(etime-esecs,3600)/60;
            ehours=etime-esecs-emins*60;
            waitbar(progress, wbh, [num2str(100*progress) '% done in '...
                num2str(ehours) ' hours, ' num2str(emins) ' minutes, and ' num2str(esecs) ' seconds']);
        elseif etime-lasttime>30
            disp([num2str(100*progress) '% done in ' num2str(etime) ' seconds'])
            lasttime=etime;
        elseif (waitmode==-1&&etime>=1)
            if progress<(0.0032*etime)
                waitmode=0;
                %set up progress bar if wait length is long enough
                wbh=waitbar(0, '0% done');
                set(wbh, 'name', ['parsekmlstr saving data to ' outfile '...']);
                waitbar(progress, wbh, [num2str(100*progress)...
                    '% done']);
            else
                waitmode=1;
            end
        end
    end
end
if waitmode==0
    close(wbh);
end
